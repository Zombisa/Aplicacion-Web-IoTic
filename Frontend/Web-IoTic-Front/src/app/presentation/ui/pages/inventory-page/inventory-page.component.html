<div class="inventory-container">
  <h2 class="title">
    <span class="cube">ğŸ“¦</span>
    Inventario de Componentes ElectrÃ³nicos
  </h2>

  <!--  Resumen general -->
  <
  <div class="summary">
    <div class="card">
      <h4>Total Ãtems</h4>
      <p>{{ totalItems }}</p>
    </div>
    <div class="card available">
      <h4>Disponibles</h4>
      <p>{{ totalDisponibles }}</p>
    </div>
    <div class="card borrowed">
      <h4>Prestados</h4>
      <p>{{ totalPrestados }}</p>
    </div>
    <div class="card low">
      <h4>Dado de baja</h4>
      <p>{{ totalBaja }}</p>
    </div>
  </div>

  <!--  Filtros -->
  <div class="filters">
    <input [(ngModel)]="filtro.nombre" placeholder="Buscar por referencia o descripciÃ³n" />

    <select [(ngModel)]="filtro.estado">
      <option value="">Todos los estados</option>

      <optgroup label="Estado fÃ­sico">
        @for (e of estados; track e) {
        <option [value]="e">{{ e }}</option>
        } @empty {
        <option disabled>â€” Sin estados â€”</option>
        }
      </optgroup>

      <optgroup label="Estado administrativo">
        <option value="Disponible">Disponible</option>
        <option value="Prestado">Prestado</option>
        <option value="Asignado">Asignado</option>
        <option value="Dado de baja">Dado de baja</option>
      </optgroup>
    </select>

    <button class="btn-primary" (click)="abrirModal()">â• Agregar</button>
  </div>

  <!--  Tabla de componentes -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>NÃºmero de Serie</th>
          <th>DescripciÃ³n</th>
          <th>Cantidad</th>
          <th>UbicaciÃ³n</th>
          <th>Estado fÃ­sico</th>
          <th>Estado administrativo</th>
          <th class="acciones">Acciones</th>
        </tr>
      </thead>

      <tbody>
        @for (c of components | filterInventory : filtro; track c.id) {
        <tr>
          <td>{{ c.numSerie }}</td>
          <td>{{ c.descripcion }}</td>
          <td>{{ c.cantidad }}</td>
          <td>{{ c.ubicacion }}</td>
          <td>{{ c.estadoFisico }}</td>
          <td>
            <span
              class="estadoAdministrativo"
              [ngClass]="{
                disponible: c.estadoAdministrativo === 'Disponible',
                prestado:
                  c.estadoAdministrativo === 'Prestado' || c.estadoAdministrativo === 'Asignado',
                baja: c.estadoAdministrativo === 'Dado de baja'
              }"
            >
              {{ c.estadoAdministrativo }}
            </span>
          </td>

          <td class="acciones">
            <button title="Editar" (click)="abrirModal(c)">âœï¸</button>
            <button title="Registrar prÃ©stamo" (click)="abrirPrestamoModal(c, 'PRESTAMO')">
              ğŸ“¤
            </button>
            <button title="Registrar devoluciÃ³n" (click)="abrirPrestamoModal(c, 'DEVOLUCION')">
              ğŸ“¥
            </button>
            <button title="Dar de baja" (click)="darDeBaja(c)">ğŸ“‰</button>
            <button title="Eliminar" class="danger" (click)="eliminar(c.id)">ğŸ—‘ï¸</button>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
</div>

<!--  Toast de notificaciÃ³n -->
<div class="toast" *ngIf="toastVisible">
  {{ toastMessage }}
</div>

<!--  Modal Agregar / Editar -->
<dialog #modal>
  <form method="dialog" class="modal">
    <h3>{{ editando ? 'Editar' : 'Agregar' }} componente</h3>

    <div class="grid">
      <label>
        <span>NÃºmero de serie</span>
        <input [(ngModel)]="form.numSerie" name="numSerie" required />
      </label>

      <label>
        <span>DescripciÃ³n</span>
        <input [(ngModel)]="form.descripcion" name="descripcion" required />
      </label>

      <label>
        <span>Cantidad</span>
        <input type="number" [(ngModel)]="form.cantidad" name="cantidad" min="0" />
      </label>

      <label>
        <span>UbicaciÃ³n</span>
        <input [(ngModel)]="form.ubicacion" name="ubicacion" />
      </label>

      <label>
        <span>Estado fÃ­sico</span>
        <select [(ngModel)]="form.estadoFisico" name="estadoFisico">
          <option *ngFor="let e of estados" [value]="e">{{ e }}</option>
        </select>
      </label>

      <label>
        <span>Observaciones</span>
        <textarea [(ngModel)]="form.observacion" name="observacion"></textarea>
      </label>
    </div>

    <div class="modal-actions">
      <button type="button" (click)="guardar()" class="btn-primary">Guardar</button>
      <button type="button" (click)="cerrarModal()">Cancelar</button>
    </div>
  </form>
</dialog>

<!--  Modal PrÃ©stamo / DevoluciÃ³n -->
<dialog #prestamoModal class="modal-prestamo">
  <h3>
    {{ prestamoForm.tipo === 'PRESTAMO' ? 'Registrar prÃ©stamo' : 'Registrar devoluciÃ³n' }}
  </h3>

  <!--  PrÃ©stamo -->
  <form
    *ngIf="prestamoForm.tipo === 'PRESTAMO'"
    (ngSubmit)="procesarPrestamoDevolucion()"
    class="form-prestamo"
  >
    <label>Usuario:</label>
    <input type="text" [(ngModel)]="prestamoForm.usuario" name="usuario" required />

    <label>Cantidad:</label>
    <input type="number" [(ngModel)]="prestamoForm.cantidad" name="cantidad" min="1" required />

    <div class="botones">
      <button type="submit" class="btn-primary">Prestar</button>
      <button type="button" (click)="cerrarPrestamoModal()" class="btn-cancelar">Cancelar</button>
    </div>
  </form>

  <!--  DevoluciÃ³n -->
  <div *ngIf="prestamoForm.tipo === 'DEVOLUCION'" class="devolucion-lista">
    <p *ngIf="prestamosPendientes.length === 0">No hay prÃ©stamos pendientes.</p>

    <ul *ngIf="prestamosPendientes.length > 0">
      <li *ngFor="let p of prestamosPendientes; trackBy: trackByPrestamo">
        <strong>{{ p.usuario }}</strong> â€” {{ p.cantidad }} unidad(es) â€” {{ p.fecha }}
        <button (click)="marcarDevuelto(p)">âœ… Devuelto</button>
      </li>
    </ul>

    <div class="botones">
      <button type="button" (click)="cerrarPrestamoModal()" class="btn-cancelar">Cerrar</button>
    </div>
  </div>
</dialog>
