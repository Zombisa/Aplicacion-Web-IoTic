<div class="inventory-container">
  <h2 class="title">
    <span class="cube">üì¶</span>
    Inventario de Dispositivos
  </h2>

  <!--  Resumen -->
  <div class="summary">
    <div class="card">
      <h4>Total √çtems</h4>
      <p>{{ totalItems }}</p>
    </div>
    <div class="card available">
      <h4>Disponibles</h4>
      <p>{{ totalDisponibles }}</p>
    </div>
    <div class="card borrowed">
      <h4>Prestados</h4>
      <p>{{ totalPrestados }}</p>
    </div>
    <div class="card low">
      <h4>Dado de baja</h4>
      <p>{{ totalBaja }}</p>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters">
    <input [(ngModel)]="filtro.nombre" placeholder="Buscar por nombre o referencia" />

    <select [(ngModel)]="filtro.estado">
      <option value="">Todos los estados</option>
      @for (e of estados; track e) {
      <option [value]="e">{{ e }}</option>
      }
    </select>
    <button class="btn-primary" (click)="abrirModal()">‚ûï Agregar</button>
  </div>

  <!-- Tabla -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Ref.</th>
          <th>Nombre</th>
          <th>Tipo</th>
          <th class="num">Disp.</th>
          <th class="num">Prest.</th>
          <th>Estado</th>
          <th class="acciones">Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (d of devices | filterInventory : filtro; track d.referencia) {
        <tr>
          <td>{{ d.referencia }}</td>
          <td>
            <div class="nombre">
              <div class="n">{{ d.nombre }}</div>
            </div>
          </td>
          <td>{{ d.tipo === 'CONSUMIBLE' ? 'Consumible' : 'No consumible' }}</td>
          <td class="num">{{ getCantidadDisponible(d) }}</td>
          <td class="num">{{ getCantidadPrestada(d) }}</td>
          <td>
            <span
              class="estado"
              [ngClass]="{
                prestado: d.estado === 'Prestado',
                disponible: d.estado === 'Disponible',
                baja: d.estado === 'Dado de baja'
              }"
            >
              {{ d.estado }}
            </span>
          </td>
          <td class="acciones">
            <button title="Editar" (click)="editar(d)">‚úèÔ∏è</button>
            <button title="Pr√©stamo" (click)="abrirPrestamoModal(d, 'PRESTAMO')">üì§</button>
            <button title="Devoluci√≥n" (click)="abrirPrestamoModal(d, 'DEVOLUCION')">üì•</button>
            <button title="Dar de baja" (click)="registrarBaja(d)">üìâ</button>
            <button title="Eliminar" class="danger" (click)="eliminar(d.id)">üóëÔ∏è</button>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
</div>

<div class="toast" *ngIf="toastVisible">
  {{ toastMessage }}
</div>

<!--  Modal Agregar/Editar -->
<dialog #modal>
  <form method="dialog" class="modal">
    <h3>{{ editando ? 'Editar' : 'Agregar' }} √≠tem</h3>

    <div class="grid">
      <label>
        <span>Referencia</span>
        <input [(ngModel)]="form.referencia" name="referencia" required />
      </label>

      <label>
        <span>Nombre</span>
        <input [(ngModel)]="form.nombre" name="nombre" required />
      </label>

      <label>
        <span>Tipo</span>
        <select [(ngModel)]="form.tipo" name="tipo">
          <option value="CONSUMIBLE">Consumible</option>
          <option value="NO_CONSUMIBLE">No consumible</option>
        </select>
      </label>

      <label>
        <span>Cantidad</span>
        <input type="number" [(ngModel)]="form.cantidad" name="cantidad" min="0" />
      </label>

      <label>
        <span>Estado</span>
        <select [(ngModel)]="form.estado" name="estado">
          <option *ngFor="let e of estados" [value]="e">{{ e }}</option>
        </select>
      </label>

      <label>
        <span>Fecha adquisici√≥n</span>
        <input type="date" [(ngModel)]="form.fechaAdquisicion" name="fechaAdquisicion" />
      </label>
    </div>

    <div class="modal-actions">
      <button type="button" (click)="guardar()" class="btn-primary">Guardar</button>
      <button type="button" (click)="cerrarModal()">Cancelar</button>
    </div>
  </form>
</dialog>

<dialog #prestamoModal class="modal-prestamo">
  <h3>
    {{ prestamoForm.tipo === 'PRESTAMO' ? 'Registrar pr√©stamo' : 'Registrar devoluci√≥n' }}
  </h3>

  <!-- Si es pr√©stamo -->
  @if (prestamoForm.tipo === 'PRESTAMO') {
  <form (ngSubmit)="procesarPrestamoDevolucion()" class="form-prestamo">
    <label>Usuario:</label>
    <input type="text" [(ngModel)]="prestamoForm.usuario" name="usuario" required />

    <label>Cantidad:</label>
    <input type="number" [(ngModel)]="prestamoForm.cantidad" name="cantidad" min="1" required />

    <div class="botones">
      <button type="submit" class="btn-primary">Prestar</button>
      <button type="button" (click)="cerrarPrestamoModal()" class="btn-cancelar">Cancelar</button>
    </div>
  </form>
}


  <!-- Si es devoluci√≥n -->
  @if (prestamoForm.tipo === 'DEVOLUCION') {
  <div class="devolucion-lista">
    @if (prestamosPendientes.length === 0) {
    <p>No hay pr√©stamos pendientes.</p>
    } @if (prestamosPendientes.length > 0) {
    <ul>
      @for (p of prestamosPendientes; track p.id) {
      <li>
        <strong>{{ p.usuario }}</strong> ‚Äî {{ p.cantidad }} unidad(es) ‚Äî {{ p.fecha }}
        <button (click)="marcarDevuelto(p)">‚úÖ Devuelto</button>
      </li>
      }
    </ul>
    }
    <div class="botones">
      <button type="button" (click)="cerrarPrestamoModal()" class="btn-cancelar">Cerrar</button>
    </div>
  </div>
  }
</dialog>
